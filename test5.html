<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Weily & Duck é›†å›¢èµ„äº§ç›˜ç‚¹æ¸…å•</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }

    .preview-image {
      position: absolute;
      max-width: 500px;
      max-height: 500px;
      border: 2px solid #ccc;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      background: white;
      padding: 10px;
      object-fit: contain; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
      transition: none !important; /* ç¦ç”¨æ‰€æœ‰è¿‡æ¸¡æ•ˆæœ */
    }

    #sidebar {
      width: 250px;
      background: #f3f3f3;
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }

    #content {
      flex: 1;
      padding: 20px;
      overflow: auto;
    }

    ul {
      list-style: none;
      padding-left: 20px;
    }

    li {
      margin: 4px 0;
    }

    li > span {
      cursor: pointer;
      display: inline-block;
    }

    li > span:hover {
      text-decoration: underline;
    }

    table {
      width: 100%;
      table-layout: auto; /* è‡ªåŠ¨è°ƒæ•´åˆ—å®½ï¼Œç¡®ä¿å•å…ƒæ ¼é«˜åº¦è‡ªåŠ¨ */
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ç›˜ç‚¹ç¼–å·ï¼šå†…å®¹ä¸å¯æ¢è¡Œï¼Œå®½åº¦è‡ªåŠ¨ */
    th[data-header="ç›˜ç‚¹ç¼–å·"], td[data-header="ç›˜ç‚¹ç¼–å·"] {
      width: auto;
      white-space: nowrap;
    }

    /* æ‰€å±å…¬å¸ï¼šæ ‡é¢˜ä¸å¯æ¢è¡Œï¼Œå®½åº¦è‡ªåŠ¨ */
    th[data-header="æ‰€å±å…¬å¸"], td[data-header="æ‰€å±å…¬å¸"] {
      width: auto;
      white-space: nowrap;
    }

    /* èµ„äº§åç§°åˆ—å®½åº¦ä¸º200ï¼Œæ ‡é¢˜ä¸å¯æ¢è¡Œ */
    th[data-header="èµ„äº§åç§°"], td[data-header="èµ„äº§åç§°"] {
      width: 200px;
      white-space: nowrap;
    }

    /* èµ„äº§åç§°æ³•è¯­åˆ—å®½åº¦ä¸º200ï¼Œæ ‡é¢˜ä¸å¯æ¢è¡Œ */
    th[data-header="èµ„äº§åç§°æ³•è¯­"], td[data-header="èµ„äº§åç§°æ³•è¯­"] {
      width: 200px;
      white-space: nowrap;
    }

    /* è§„æ ¼ / å‹å· / ç‰¹å¾ï¼šæ ‡é¢˜ä¸å¯æ¢è¡Œï¼Œå†…å®¹ä¸å¯æ¢è¡Œ */
    th[data-header="è§„æ ¼ / å‹å· / ç‰¹å¾"], td[data-header="è§„æ ¼ / å‹å· / ç‰¹å¾"] {
      width: 200px;
      white-space: nowrap;
    }

    /* é™„æ³¨ï¼šå®½åº¦è‡ªåŠ¨ï¼Œå†…å®¹ä¸å¯æ¢è¡Œ */
    th[data-header="é™„æ³¨"], td[data-header="é™„æ³¨"] {
      width: auto;
      white-space: nowrap; /* å†…å®¹ä¸å¯æ¢è¡Œ */
    }

    /* è¯¦ç»†åœ°ç‚¹ï¼šå†…å®¹ä¸å¯æ¢è¡Œï¼Œå®½åº¦è‡ªåŠ¨ */
    th[data-header="è¯¦ç»†åœ°ç‚¹"], td[data-header="è¯¦ç»†åœ°ç‚¹"] {
      width: auto;
      white-space: nowrap;
    }

    /* èµ„äº§çŠ¶æ€åˆ—ã€ç›˜åæ•°é‡ã€å•ä½å®½åº¦è‡ªåŠ¨ï¼Œæ ‡é¢˜ä¸å¯æ¢è¡Œ */
    th[data-header="èµ„äº§çŠ¶æ€"], td[data-header="èµ„äº§çŠ¶æ€"],
    th[data-header="ç›˜åæ•°é‡"], td[data-header="ç›˜åæ•°é‡"],
    th[data-header="å•ä½"], td[data-header="å•ä½"] {
      width: auto;
      white-space: nowrap;
    }

    /* ç›˜ç‚¹æ—¶é—´ã€å…¥åº“æ—¶é—´ï¼šå†…å®¹ä¸å¯æ¢è¡Œ */
    th[data-header="ç›˜ç‚¹æ—¶é—´"], td[data-header="ç›˜ç‚¹æ—¶é—´"],
    th[data-header="å…¥åº“æ—¶é—´"], td[data-header="å…¥åº“æ—¶é—´"] {
      white-space: nowrap;
    }

    /* é¢„è®¡ä½¿ç”¨å¹´é™ã€å·²ä½¿ç”¨å¹´é™ã€å‰©ä½™ä½¿ç”¨å¹´é™ï¼šå®½åº¦ä¸€è‡´ï¼Œæ ‡é¢˜ä¸å¯æ¢è¡Œ */
    th[data-header="é¢„è®¡ä½¿ç”¨å¹´é™"], td[data-header="é¢„è®¡ä½¿ç”¨å¹´é™"],
    th[data-header="å·²ä½¿ç”¨å¹´é™"], td[data-header="å·²ä½¿ç”¨å¹´é™"],
    th[data-header="å‰©ä½™ä½¿ç”¨å¹´é™"], td[data-header="å‰©ä½™ä½¿ç”¨å¹´é™"] {
      width: 200px;
      white-space: nowrap; /* æ ‡é¢˜ä¸å¯æ¢è¡Œ */
    }

    /* å¤‡æ³¨ï¼šå®½åº¦è‡ªåŠ¨ï¼Œæ ‡é¢˜ä¸å¯æ¢è¡Œ */
    th[data-header="å¤‡æ³¨"], td[data-header="å¤‡æ³¨"] {
      width: auto;
      white-space: nowrap;
    }

    /* èµ„äº§ä½¿ç”¨äººåˆ—å®½åº¦å›ºå®šä¸º80 */
    th[data-header="èµ„äº§ä½¿ç”¨äºº"], td[data-header="èµ„äº§ä½¿ç”¨äºº"] {
      width: 80px;
      white-space: nowrap;
    }
    /* å“ç‰Œæ ï¼šæ ‡é¢˜ä¸æ¢è¡Œ */
    th[data-header="å“ç‰Œ"], td[data-header="å“ç‰Œ"] {
     white-space: nowrap;
    }

    /* æ–°å¢é¢„è§ˆåˆ—æ ·å¼ */
    th[data-header="é¢„è§ˆ"], td[data-header="é¢„è§ˆ"] {
      width: 80px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
    }

    /* é˜²æ­¢æç¤ºé—ªçƒ */
      td[data-header="é¢„è§ˆ"] {
          position: relative;
      }

      td[data-header="é¢„è§ˆ"]:hover::after {
          content: "ç‚¹å‡»æŸ¥çœ‹èµ„äº§å›¾ç‰‡";
          position: absolute;
          bottom: 100%;
          left: 50%;
          transform: translateX(-50%);
          background: #333;
          color: #fff;
          padding: 5px 10px;
          border-radius: 4px;
          font-size: 12px;
          white-space: nowrap;
          z-index: 1001;
          pointer-events: none;
      }

    /* é»˜è®¤éšè—åˆ—ï¼ˆè½¦æ¶å·ã€å‹å·ä»£ç ã€ä¼°ç®—å•ä»·ã€å…¥åº“æ—¶é—´ï¼‰ */
    .hidden-column {
      display: none;
    }

    /* æ–°å¢æ ·å¼ */
    .empty-message {
      text-align: center;
      color: #aaa;
    }

    span.active {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>èµ„äº§åˆ†ç±»</h3>
    <input type="file" id="upload" accept=".xlsx" style="display:none" />
    <div id="tree"></div>
  </div>

  <div id="content">
    <h3 id="title">è¯·ç‚¹å‡»å·¦ä¾§åˆ†ç±»æŸ¥çœ‹</h3>
    <div id="table-area">è¯·å…ˆä¸Šä¼ èµ„äº§æ¸…å•æ–‡ä»¶å¹¶ç‚¹å‡»åˆ†ç±»æŸ¥çœ‹æ˜ç»†ã€‚</div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let allData = [];
    let treeData = {};
    let previewImage = null; // æ·»åŠ è¿™è¡Œ
    let previewTimer = null;
    const PREVIEW_DELAY = 500;

    function initPreviewImage() {
    if (!previewImage) {
        previewImage = document.createElement('img');
        previewImage.className = 'preview-image';
        document.body.appendChild(previewImage);
    }
}

  // ä¿®æ­£åçš„ showPreviewImage å‡½æ•°
  function showPreviewImage(event, assetId) {
      // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
      clearTimeout(previewTimer);

      if (!previewImage) initPreviewImage();

      // æ£€æŸ¥assetIdæ˜¯å¦æœ‰æ•ˆ
      if (!assetId || assetId.trim() === "") {
          console.error("æ— æ•ˆçš„èµ„äº§ID");
          return;
      }

      // è®¾ç½®å»¶è¿Ÿæ˜¾ç¤º
      previewTimer = setTimeout(() => {
          // æ¸…ç†å¯èƒ½çš„æ—§äº‹ä»¶ç›‘å¬
          previewImage.onload = null;
          previewImage.onerror = null;

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          previewImage.alt = "åŠ è½½ä¸­...";
          previewImage.style.display = 'block';

          // å®šä½å›¾ç‰‡ï¼ˆé¿å¼€å±å¹•è¾¹ç¼˜ï¼‰
          const x = Math.min(event.clientX + 20, window.innerWidth - 520);
          const y = Math.min(event.clientY + 20, window.innerHeight - 520);
          previewImage.style.left = `${x}px`;
          previewImage.style.top = `${y}px`;

          // ä¿®æ”¹å›¾ç‰‡è·¯å¾„æ ¼å¼
          const imgPath = `https://test-1359186450.cos.ap-guangzhou.myqcloud.com/ç¼©ç•¥å›¾/${encodeURIComponent(assetId)}/${encodeURIComponent(assetId)}-ç¼©ç•¥å›¾.jpg`;
          console.log("åŠ è½½å›¾ç‰‡è·¯å¾„:", imgPath);

          // ä½¿ç”¨Imageå¯¹è±¡é¢„åŠ è½½
          const loader = new Image();
          loader.src = imgPath;

          loader.onload = () => {
              previewImage.src = imgPath;
              previewImage.alt = assetId;
              console.log("å›¾ç‰‡åŠ è½½æˆåŠŸ");
          };

          loader.onerror = () => {
              console.error("å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨è·¯å¾„");
              fallbackLoader.src = `https://test-1359186450.cos.ap-guangzhou.myqcloud.com/ç¼©ç•¥å›¾/${encodeURIComponent(assetId)}/${encodeURIComponent(assetId)}-ç¼©ç•¥å›¾.jpg`;
              const fallbackLoader = new Image();
              fallbackLoader.src = fallbackPath;

              fallbackLoader.onload = () => {
                  previewImage.src = fallbackPath;
              };

              fallbackLoader.onerror = () => {
                  console.error("æ‰€æœ‰å›¾ç‰‡è·¯å¾„å°è¯•å¤±è´¥");
                  previewImage.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='500' height='500'><rect width='100%' height='100%' fill='#eee'/><text x='50%' y='50%' font-family='sans-serif' font-size='14' text-anchor='middle'>å›¾ç‰‡æœªæ‰¾åˆ°</text></svg>";
              };
          };
      }, PREVIEW_DELAY);
  }

  // hidePreviewImage ä¿æŒä¸å˜
  function hidePreviewImage() {
      clearTimeout(previewTimer);
      if (previewImage) {
          previewImage.style.display = 'none';
          previewImage.src = '';
      }
  }
  document.addEventListener('DOMContentLoaded', function() {
  loadRemoteExcel();
  document.getElementById('table-area').textContent = "æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...";
});



    async function loadRemoteExcel() {
  const fileUrl = "https://test-1359186450.cos.ap-guangzhou.myqcloud.com/æµ‹è¯•æ•°æ®2.xlsx";

  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('table-area').innerHTML = `
      <div style="text-align:center; padding:20px;">
        <div class="spinner"></div>
        <p>æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...</p>
      </div>`;

    // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
    const timestamp = new Date().getTime();
    const url = `${fileUrl}?t=${timestamp}`;

    // å‘èµ·è¯·æ±‚
    const response = await fetch(url);

    if (!response.ok) {
      throw new Error(`HTTPé”™è¯¯ ${response.status}`);
    }

    // è·å–ArrayBuffer
    const arrayBuffer = await response.arrayBuffer();

    // è§£æExcel
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

    // å¤„ç†æ•°æ®
    allData = jsonData.map(item => ({
      'é¢„è§ˆ': 'é¢„è§ˆ',
      ...item
    }));

    // ç”Ÿæˆç›®å½•æ ‘å’Œè¡¨æ ¼
    generateTree(allData);
    buildTree();

    // æ›´æ–°çŠ¶æ€
    document.getElementById('table-area').innerHTML = `
      <p style="text-align:center; color:green;">
        æ•°æ®åŠ è½½å®Œæˆï¼Œå…± ${allData.length} æ¡è®°å½•
      </p>`;

  } catch (error) {
    console.error('åŠ è½½å¤±è´¥:', error);
    document.getElementById('table-area').innerHTML = `
      <div style="color:red; padding:20px;">
        <h4>æ•°æ®å¤„ç†å¤±è´¥</h4>
        <p>è¯¦ç»†é”™è¯¯: ${error.message}</p>
        <p>è¯·æ±‚URL: ${fileUrl}</p>
        <p>å¯èƒ½åŸå› :</p>
        <ol>
          <li>è·¨åŸŸé—®é¢˜ - è¯·æ£€æŸ¥COS CORSè®¾ç½®</li>
          <li>æ–‡ä»¶ä¸å­˜åœ¨æˆ–URLé”™è¯¯</li>
          <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
        </ol>
        <button onclick="loadRemoteExcel()">ğŸ”„ é‡æ–°åŠ è½½</button>
      </div>`;
  } // è¿™é‡Œæ·»åŠ äº†ç¼ºå°‘çš„é—­åˆå¤§æ‹¬å·
}



function generateTree(data) {
  treeData = { "å…¨éƒ¨": {} }; // æ·»åŠ â€œå…¨éƒ¨â€åˆ†ç±»

  data.forEach(item => {
    const cat1 = item["èµ„äº§åˆ†ç±»"] || "æœªåˆ†ç±»";
    const cat2 = item["æ˜ç»†åˆ†ç±»"] || "";

    // åˆå§‹åŒ–â€œå…¨éƒ¨â€åˆ†ç±»
    if (!treeData["å…¨éƒ¨"][cat1]) {
      treeData["å…¨éƒ¨"][cat1] = {};
    }
    if (cat2 && !treeData["å…¨éƒ¨"][cat1][cat2]) {
      treeData["å…¨éƒ¨"][cat1][cat2] = {};
    }

    // åˆå§‹åŒ–å¸¸è§„åˆ†ç±»
    if (!treeData[cat1]) {
      treeData[cat1] = {};
    }
    if (cat2 && !treeData[cat1][cat2]) {
      treeData[cat1][cat2] = {};
    }

    // åŠ¨æ€åˆ›å»ºåŠå…¬å®¶å…·å­ç±»
    if (cat1 === "åŠå…¬è®¾å¤‡" && cat2 === "åŠå…¬å®¶å…·") {
      const assetName = item["èµ„äº§åç§°"] || "";

      // æ£€æŸ¥æ˜¯å¦å±äºå·²çŸ¥å­åˆ†ç±»
      let isKnownSubCategory = false;

      // æŸœå­å­ç±»
      if (assetName.includes("æŸœ")) {
        if (!treeData[cat1][cat2]["æŸœå­"]) {
          treeData[cat1][cat2]["æŸœå­"] = true;
        }
        isKnownSubCategory = true;
      }

      // æ¤…å­&åœ†å‡³å­ç±»
      if (assetName.includes("æ¤…") || assetName.includes("å‡³")) {
        if (!treeData[cat1][cat2]["æ¤…å­&åœ†å‡³"]) {
          treeData[cat1][cat2]["æ¤…å­&åœ†å‡³"] = true;
        }
        isKnownSubCategory = true;
      }

      // æ¡Œå­å­ç±»
      if (assetName.includes("æ¡Œ")) {
        if (!treeData[cat1][cat2]["æ¡Œå­"]) {
          treeData[cat1][cat2]["æ¡Œå­"] = true;
        }
        isKnownSubCategory = true;
      }

      // å¦‚æœä¸å±äºä»»ä½•å·²çŸ¥å­åˆ†ç±»ï¼Œåˆ™å½’å…¥"å…¶ä»–"
      if (!isKnownSubCategory) {
        if (!treeData[cat1][cat2]["å…¶ä»–"]) {
          treeData[cat1][cat2]["å…¶ä»–"] = true;
        }
      }
    }

    // æ–°å¢ï¼šå¯¹å…¶ä»–ç”µå­è®¾å¤‡çš„å­åˆ†ç±»
    if (cat1 === "åŠå…¬è®¾å¤‡" && cat2 === "å…¶ä»–ç”µå­è®¾å¤‡") {
      const assetName = item["èµ„äº§åç§°"] || "";

      // ç”µè¯æœºå­ç±»
      if (assetName.includes("ç”µè¯æœº")) {
        if (!treeData[cat1][cat2]["ç”µè¯æœº"]) {
          treeData[cat1][cat2]["ç”µè¯æœº"] = true;
        }
      }
      // å…¶ä»–å­ç±»
      else {
        if (!treeData[cat1][cat2]["å…¶ä»–"]) {
          treeData[cat1][cat2]["å…¶ä»–"] = true;
        }
      }
    }
  });
}
function buildTree() {
  const treeContainer = document.getElementById('tree');
  treeContainer.innerHTML = '';

  const ul = document.createElement('ul');

  // æ·»åŠ â€œå…¨éƒ¨â€åˆ†ç±»
  const allLi = document.createElement('li');
  const allSpan = document.createElement('span');
  allSpan.textContent = 'å…¨éƒ¨';
  allSpan.addEventListener('click', (e) => {
    setActiveItem(e.target);
    renderTable(null, null, { name: "å…¨éƒ¨", keyword: null });
  });
  allLi.appendChild(allSpan);
  ul.appendChild(allLi);

  for (let cat1 in treeData) {
    if (cat1 === "å…¨éƒ¨") continue; // è·³è¿‡â€œå…¨éƒ¨â€åˆ†ç±»æœ¬èº«

    const li = document.createElement('li');
    const span = document.createElement('span');
    span.textContent = cat1;
    span.addEventListener('click', (e) => {
      setActiveItem(e.target);
      renderTable(cat1);
    });
    li.appendChild(span);

    const subUl = document.createElement('ul');
    for (let cat2 in treeData[cat1]) {
      if (!cat2) continue;

      const subLi = document.createElement('li');
      const subSpan = document.createElement('span');
      subSpan.textContent = cat2;
      subSpan.addEventListener('click', (e) => {
        setActiveItem(e.target);
        renderTable(cat1, cat2);
      });
      subLi.appendChild(subSpan);

      // åŠå…¬å®¶å…·å­åˆ†ç±»
      if (cat1 === "åŠå…¬è®¾å¤‡" && cat2 === "åŠå…¬å®¶å…·") {
        const subSubUl = document.createElement('ul');

        if (treeData[cat1][cat2]["æŸœå­"]) {
          const subSubLi = createSubCategoryItem(cat1, cat2, "æŸœå­", "æŸœ");
          subSubUl.appendChild(subSubLi);
        }

        if (treeData[cat1][cat2]["æ¤…å­&åœ†å‡³"]) {
          const subSubLi = createSubCategoryItem(cat1, cat2, "æ¤…å­&åœ†å‡³", "æ¤…|å‡³");
          subSubUl.appendChild(subSubLi);
        }

        if (treeData[cat1][cat2]["æ¡Œå­"]) {
          const subSubLi = createSubCategoryItem(cat1, cat2, "æ¡Œå­", "æ¡Œ");
          subSubUl.appendChild(subSubLi);
        }

        if (treeData[cat1][cat2]["å…¶ä»–"]) {
          const subSubLi = document.createElement('li');
          const subSubSpan = document.createElement('span');
          subSubSpan.textContent = "å…¶ä»–";
          subSubSpan.addEventListener('click', (e) => {
            setActiveItem(e.target);
            renderTable(cat1, cat2, { name: "å…¶ä»–", keyword: null });
          });
          subSubLi.appendChild(subSubSpan);
          subSubUl.appendChild(subSubLi);
        }

        subLi.appendChild(subSubUl);
      }

      // å…¶ä»–ç”µå­è®¾å¤‡å­åˆ†ç±»ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰
      if (cat1 === "åŠå…¬è®¾å¤‡" && cat2 === "å…¶ä»–ç”µå­è®¾å¤‡") {
        const subSubUl = document.createElement('ul');

        if (treeData[cat1][cat2]["ç”µè¯æœº"]) {
          const subSubLi = createSubCategoryItem(cat1, cat2, "ç”µè¯æœº", "ç”µè¯æœº");
          subSubUl.appendChild(subSubLi);
        }

        if (treeData[cat1][cat2]["å…¶ä»–"]) {
          const subSubLi = document.createElement('li');
          const subSubSpan = document.createElement('span');
          subSubSpan.textContent = "å…¶ä»–";
          subSubSpan.addEventListener('click', (e) => {
            setActiveItem(e.target);
            renderTable(cat1, cat2, {
              name: "å…¶ä»–",
              keyword: null,
              exclude: "ç”µè¯æœº"
            });
          });
          subSubLi.appendChild(subSubSpan);
          subSubUl.appendChild(subSubLi);
        }

        subLi.appendChild(subSubUl);
      }

      subUl.appendChild(subLi);
    }
    li.appendChild(subUl);
    ul.appendChild(li);
  }
  treeContainer.appendChild(ul);
}

    // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºå­åˆ†ç±»é¡¹
    function createSubCategoryItem(cat1, cat2, subCatName, keyword) {
      const subSubLi = document.createElement('li');
      const subSubSpan = document.createElement('span');
      subSubSpan.textContent = subCatName;
      subSubSpan.addEventListener('click', (e) => {
        setActiveItem(e.target);
        renderTable(cat1, cat2, { name: subCatName, keyword: keyword });
      });
      subSubLi.appendChild(subSubSpan);
      return subSubLi;
    }

    function setActiveItem(target) {
      const spans = document.querySelectorAll('#tree span');
      spans.forEach(span => span.classList.remove('active'));
      target.classList.add('active');
    }

function renderTable(cat1 = null, cat2 = null, subCat = null) {
  let filtered;

  if (subCat && subCat.name === "å…¨éƒ¨") {
    // æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
    filtered = allData;
  } else {
    filtered = allData.filter(item => {
      const matchCategory = item["èµ„äº§åˆ†ç±»"] === cat1 &&
                            (cat2 ? item["æ˜ç»†åˆ†ç±»"] === cat2 : true);

      if (!subCat) return matchCategory;

      const assetName = item["èµ„äº§åç§°"] || "";

      if (typeof subCat === 'object') {
        if (!subCat.keyword) {
          const isKnownSubCategory =
            assetName.includes("æŸœ") ||
            assetName.includes("æ¤…") ||
            assetName.includes("å‡³") ||
            assetName.includes("æ¡Œ");
          return matchCategory && !isKnownSubCategory;
        } else {
          const keywords = subCat.keyword.split('|');
          return matchCategory &&
                 keywords.some(k => assetName.includes(k));
        }
      }

      return matchCategory;
    });
  }

  const title = document.getElementById('title');
  title.textContent = subCat && subCat.name === "å…¨éƒ¨" ? "å…¨éƒ¨èµ„äº§" :
                      subCat ? `${cat1} > ${cat2} > ${typeof subCat === 'object' ? subCat.name : subCat}` :
                              (cat2 ? `${cat1} > ${cat2}` : cat1);

  if (filtered.length === 0) {
    document.getElementById('table-area').innerHTML = '<p class="empty-message">æ— æ•°æ®</p>';
    return;
  }

  // æ ¹æ®é€‰æ‹©çš„åˆ†ç±»ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºè½¦æ¶å·åˆ—
  const showVehicleInfo = cat1 && (cat1.includes("è½¦è¾†") || (cat2 && cat2.includes("è½¦è¾†")));

  const hiddenFields = [
    "å¤§ç±»", "æ˜¯å¦å›ºå®šèµ„äº§", "èµ„äº§åˆ†ç±»", "æ˜ç»†åˆ†ç±»", "è¿›å£æµ·è¿å•å·",
    "èµ„äº§ç›˜ç‚¹åˆ†ç±»ä»£ç ", "ç³»ç»Ÿä»£ç ", "åˆ¶é€ æ—¶é—´", "å®é™…åœ°ç‚¹",
    "æ˜¯å¦æŠ˜æ—§", "æ®‹å€¼", "ç…§ç‰‡", "ç³»ç»Ÿåº“å­˜åœ°ç‚¹",
    "å‹å·ä»£ç ", "ä¼°ç®—å•ä»·", "å…¥åº“æ—¶é—´"
  ];

  if (!showVehicleInfo) {
    hiddenFields.push("è½¦æ¶å·");
  }
  if (cat1 === "è½¦è¾†" && cat2 === "æ‹–è½¦å°¾") {
    hiddenFields.push("è§„æ ¼ / å‹å· / ç‰¹å¾");
  }

  const headers = ['é¢„è§ˆ'].concat(Object.keys(filtered[0])
    .filter(h => h !== 'é¢„è§ˆ' && !hiddenFields.includes(h)));

  let html = '<table><thead><tr>' +
    headers.map(h => `<th data-header="${h}">${h}</th>`).join('') +
    '</tr></thead><tbody>';

  for (let row of filtered) {
    html += '<tr>' + headers.map(h => {
      let value = row[h];
      const assetId = row["ç›˜ç‚¹ç¼–å·"] || "";

      // ç‰¹æ®Šå¤„ç†é¢„è§ˆåˆ—
      if (h === "é¢„è§ˆ") {
        return `<td data-header="${h}"
                onmouseenter="showPreviewImage(event, '${assetId.replace(/'/g, "\\'")}')"
                onmouseleave="hidePreviewImage()"  // ç¡®ä¿è°ƒç”¨æ­£ç¡®çš„å‡½æ•°
                style="cursor: pointer; color: blue; text-decoration: underline;"
                title="">
            é¢„è§ˆ
            </td>`;
      }

      // é‡‘é¢æ ¼å¼åŒ–
      if (h === "ä¼°ç®—å•ä»·" || h === "ä¼°ç®—æ€»ä»·") {
        const num = parseFloat(value);
        value = isNaN(num) ? value : num.toLocaleString("zh-CN");
      }

      // æ—¥æœŸæ ¼å¼åŒ–
      const dateFields = ["ç›˜ç‚¹æ—¶é—´", "å…¥åº“æ—¶é—´"];
      if (dateFields.includes(h)) {
        const excelDate = parseFloat(value);
        if (!isNaN(excelDate)) {
          const jsDate = new Date((excelDate - 25569) * 86400 * 1000);
          const yyyy = jsDate.getFullYear();
          const mm = String(jsDate.getMonth() + 1).padStart(2, '0');
          const dd = String(jsDate.getDate()).padStart(2, '0');
          value = `${yyyy}-${mm}-${dd}`;
        }
      }

      // å°æ•°ä¿ç•™ä¸¤ä½
      const fixedFields = ["é¢„è®¡ä½¿ç”¨å¹´é™", "å·²ä½¿ç”¨å¹´é™", "å‰©ä½™ä½¿ç”¨å¹´é™"];
      if (fixedFields.includes(h)) {
        const num = parseFloat(value);
        value = isNaN(num) ? value : num.toFixed(2);
      }

      return `<td data-header="${h}">${value}</td>`;
    }).join('') + '</tr>';
  }

  html += '</tbody></table>';
  document.getElementById('table-area').innerHTML = html;
}
  </script>
</body>
</html>
